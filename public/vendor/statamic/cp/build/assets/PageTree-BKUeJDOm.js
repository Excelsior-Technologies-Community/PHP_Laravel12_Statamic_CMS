import{_ as z,g as A,D as U,h as I,l as L,r as n,i as E,d as g,o as l,j as m,f as u,k as h,w as C,c as x,m as o,t as _,n as b,p as O,q as p,s as N,u as j,A as M,v as V,x as P,y as R,z as T,B as K,C as q}from"./index-A5ZmM1kw.js";const $={components:{Link:L,Dropdown:I,DropdownMenu:U,Icon:A},props:{page:Object,depth:Number,root:Boolean,firstPageIsRoot:Boolean,isOpen:Boolean,hasChildren:Boolean,showBlueprint:Boolean,showSlugs:Boolean,editable:{type:Boolean,default:!0},stat:Object},data(){return{editing:!1}},computed:{isTopLevelBranch(){return this.depth===1},isRoot(){return this.root},isEntry(){return!!this.page.id},isLink(){return!this.page.id&&this.page.title&&this.page.url},isText(){return this.page.title&&!this.page.url},title(){return this.page.title||this.page.entry_title||this.page.url},slugPath(){return this.isRoot?"/":"/"+this.page.slug}},methods:{getStatusTooltip(){let e=__(this.page.status)||__("Text item");return e[0].toUpperCase()+e.slice(1)},remove(e){this.$emit("removed",this.stat,e)}}},F={key:0,class:"page-move w-6"},H={class:"flex flex-1 items-center px-1.5 text-xs leading-normal"},J=["href","textContent"],G={key:1,class:"pt-[2px] font-mono text-2xs text-gray-700 dark:text-gray-500"},Q={key:3,class:"flex items-center gap-2"},W={class:"flex items-center gap-2 sm:gap-3"};function X(e,a,t,f,d,s){const D=n("ui-status-indicator"),v=n("ui-icon"),k=n("ui-button"),S=n("Icon"),y=n("Link"),w=n("ui-badge"),B=n("DropdownMenu"),c=n("Dropdown"),i=E("tooltip");return l(),g("div",{class:b(["page-tree-branch flex",{"page-tree-branch--has-children":t.hasChildren}])},[m(e.$slots,"branch-action",{branch:t.page},()=>[t.editable?(l(),g("div",F)):h("",!0)]),u("div",H,[u("div",{class:"flex gap-2 sm:gap-3 grow items-center py-3",onClick:a[2]||(a[2]=r=>e.$emit("branch-clicked",t.page))},[C(o(D,{status:t.page.status},null,8,["status"]),[[i,s.getStatusTooltip()]]),s.isRoot?C((l(),x(v,{key:0,name:"home",class:"size-4"},null,512)),[[i,e.__("This is the root page")]]):h("",!0),u("a",{onClick:a[0]||(a[0]=O(r=>e.$emit("edit",r),["prevent"])),class:b({"text-sm font-medium is-top-level-branch":s.isTopLevelBranch}),href:t.page.edit_url,textContent:_(s.title)},null,10,J),t.showSlugs?(l(),g("span",G,_(s.slugPath),1)):h("",!0),t.hasChildren?(l(),x(k,{key:2,class:b(["transition duration-100 [&_svg]:size-4! -mx-1.5",{"-rotate-90 is-closed":!t.isOpen,"is-open":t.isOpen}]),icon:"chevron-down",size:"xs",round:"",variant:"ghost","aria-label":t.isOpen?e.__("Collapse"):e.__("Expand"),"aria-expanded":t.isOpen,onClick:a[1]||(a[1]=O(r=>e.$emit("toggle-open"),["stop"]))},null,8,["class","aria-label","aria-expanded"])):h("",!0),t.page.collection&&t.editable?(l(),g("div",Q,[o(S,{name:"navigation",class:"size-3.5 text-gray-500"}),u("div",null,[o(y,{href:t.page.collection.create_url,textContent:_(e.__("Add")),class:"hover:text-ui-accent-text"},null,8,["href","textContent"]),a[3]||(a[3]=u("span",{class:"mx-1 text-gray-400 dark:text-gray-500"},"/",-1)),o(y,{href:t.page.collection.edit_url,textContent:_(e.__("Edit")),class:"hover:text-ui-accent-text"},null,8,["href","textContent"])])])):h("",!0)]),u("div",W,[t.showBlueprint&&t.page.entry_blueprint?C((l(),x(w,{key:0,text:e.__(t.page.entry_blueprint.title),size:"sm",variant:"filled"},null,8,["text"])),[[i,e.__("Blueprint")]]):h("",!0),m(e.$slots,"branch-icon",{branch:t.page}),t.editable?(l(),x(c,{key:1,placement:"left-start",class:b({invisible:s.isRoot})},{default:p(()=>[o(B,null,{default:p(()=>[m(e.$slots,"branch-options",{branch:t.page,depth:t.depth,removeBranch:s.remove})]),_:3})]),_:3},8,["class"])):h("",!0)])])],2)}const Y=z($,[["render",X]]),Z={components:{Draggable:M,TreeBranch:Y,PanelHeader:j,Panel:N,Icon:A},props:{pagesUrl:{type:String,required:!0},submitUrl:{type:String},submitParameters:{type:Object,default:()=>({})},createUrl:{type:String},site:{type:String,required:!0},localizations:{type:Array},maxDepth:{type:Number,default:1/0},expectsRoot:{type:Boolean,required:!0},showSlugs:{type:Boolean,default:!1},preferencesPrefix:{type:String},editable:{type:Boolean,default:!0},blueprints:{type:Array}},data(){return{loading:!1,saving:!1,pages:[],treeData:[],collapsedState:[],discardingChanges:!1,ready:!1}},computed:{activeLocalization(){return this.localizations.find(e=>e.active)},preferencesKey(){return this.preferencesPrefix?`${this.preferencesPrefix}.${this.site}.pagetree`:null},direction(){return this.$config.get("direction","ltr")}},watch:{site(e){this.getPages()},collapsedState:{deep:!0,handler(e){this.preferencesKey&&localStorage.setItem(this.preferencesKey,JSON.stringify(e))}}},created(){this.collapsedState=this.getCollapsedState(),this.getPages().then(()=>{this.initialPages=q(this.pages)}),this.$keys.bindGlobal(["mod+s"],e=>{e.preventDefault(),this.save()})},mounted(){setTimeout(()=>this.ready=!0,500)},methods:{isRoot(e){return this.expectsRoot?e.level===1&&e.data.id===this.treeData[0]?.id:!1},getPages(){this.loading=!0;const e=`${this.pagesUrl}?site=${this.site}`;return this.$axios.get(e).then(a=>{this.pages=a.data.pages,this.updateTreeData(),this.loading=!1,this.$emit("loaded",this.pages)})},treeUpdated(){this.pages=this.$refs.tree.getData(),this.$emit("changed",this.pages)},cleanPagesForSubmission(e){return e.map(a=>({id:a.id,children:this.cleanPagesForSubmission(a.children)}))},save(){if(!this.editable)return;this.saving=!0;const e={pages:this.cleanPagesForSubmission(this.pages),site:this.site,expectsRoot:this.expectsRoot,...this.submitParameters};return this.$axios.patch(this.submitUrl,e).then(a=>a.data.saved?(this.$emit("saved",a),this.$toast.success(__("Saved")),this.initialPages=this.pages,a):this.$toast.error("Couldn't save tree")).catch(a=>{let t=a.response?a.response.data.message:__("Something went wrong");if(a.response&&a.response.status===422){const{errors:f}=a.response.data;t=f[Object.keys(f)[0]][0]}return this.$toast.error(t),Promise.reject(a)}).finally(()=>this.saving=!1)},addPages(e,a){this.$refs.tree.addMulti(e,a),this.treeUpdated()},updateTreeData(){this.treeData=[...this.pages]},pageRemoved(e,a){const t=[];a||e.children.forEach(f=>t.push({...f.data})),this.$refs.tree.batchUpdate(()=>{this.$refs.tree.remove(e),t.length&&this.$refs.tree.addMulti(t,e.parent)}),this.treeUpdated()},localizationSelected(e){e.active||(e.exists?this.editLocalization(e):this.createLocalization(e))},editLocalization(e){K.get(e.url)},createLocalization(e){console.log("todo.")},cancel(){this.discardingChanges=!0},confirmDiscard(){this.pages=this.initialPages,this.updateTreeData(),this.$emit("canceled"),this.discardingChanges=!1},rootDroppable(){return this.expectsRoot,!0},eachDroppable(e){return this.expectsRoot?!this.isRoot(e):!0},pageUpdated(){this.pages=this.$refs.tree.getData(),this.$emit("changed",this.pages)},expandAll(){this.$refs.tree.openAll(),this.collapsedState=[]},collapseAll(){this.$refs.tree.closeAll(),this.collapsedState=[],T(this.treeData,e=>{this.collapsedState.push(e.id)})},getNodeByBranchId(e){let a;return T(this.treeData,t=>{if(t.id===e)return a=t,!1}),a},getCollapsedState(){return this.preferencesKey?JSON.parse(localStorage.getItem(this.preferencesKey)||"[]"):[]},nodeOpened(e){this.collapsedState.splice(this.collapsedState.indexOf(e.data.id),1)},nodeClosed(e){this.collapsedState.push(e.data.id)},statHandler(e){return e.open=!this.collapsedState.includes(e.data.id),e}}},ee={key:0,class:"no-results flex w-full items-center"},te={key:0,class:"loading card"},ae={class:"page-tree-header font-medium text-sm items-center flex justify-between"},se=["textContent"],ne={class:"flex gap-2"};function ie(e,a,t,f,d,s){const D=n("Icon"),v=n("ui-button"),k=n("ui-panel-header"),S=n("tree-branch"),y=n("Draggable"),w=n("ui-panel"),B=n("confirmation-modal");return l(),g("div",null,[!d.loading&&d.treeData.length==0?(l(),g("div",ee,[m(e.$slots,"empty")])):h("",!0),C(o(w,null,{default:p(()=>[d.loading?(l(),g("div",te,[o(D,{name:"loading"})])):h("",!0),o(k,null,{default:p(()=>[u("div",ae,[u("div",{textContent:_(e.__("Tree Structure"))},null,8,se),u("div",ne,[o(v,{size:"sm",icon:"tree-collapse",text:e.__("Collapse"),onClick:s.collapseAll},null,8,["text","onClick"]),o(v,{size:"sm",icon:"tree-expand",text:e.__("Expand"),onClick:s.expandAll},null,8,["text","onClick"])])])]),_:1}),d.loading?h("",!0):(l(),g("div",{key:1,class:b(["page-tree",{"page-tree--ready":d.ready}])},[o(y,{ref:"tree",modelValue:d.treeData,"onUpdate:modelValue":a[0]||(a[0]=c=>d.treeData=c),"disable-drag":!t.editable,space:1,indent:24,dir:s.direction,"node-key":c=>c.data.id,dragOverThrottleInterval:30,"each-droppable":s.eachDroppable,"root-droppable":s.rootDroppable,"max-level":t.maxDepth,"stat-handler":s.statHandler,onAfterDrop:s.treeUpdated,"onOpen:node":s.nodeOpened,"onClose:node":s.nodeClosed},{placeholder:p(()=>a[2]||(a[2]=[u("div",{class:"w-full rounded-sm border border-dashed border-blue-400 bg-blue-500/10 p-2"},"Â ",-1)])),default:p(({node:c,stat:i})=>[o(S,{ref:`branch-${c.id}`,page:c,stat:i,depth:i.level,"first-page-is-root":t.expectsRoot,"is-open":i.open,"has-children":i.children.length>0,"show-slugs":t.showSlugs,"show-blueprint":t.blueprints?.length>1,editable:t.editable,root:s.isRoot(i),onEdit:r=>e.$emit("edit-page",c,r),onToggleOpen:r=>i.open=!i.open,onRemoved:s.pageRemoved,onBranchClicked:r=>e.$emit("branch-clicked",c),class:"mb-px"},{"branch-action":p(r=>[m(e.$slots,"branch-action",P(R({...r,stat:i})))]),"branch-icon":p(r=>[m(e.$slots,"branch-icon",P(R({...r,stat:i})))]),"branch-options":p(r=>[m(e.$slots,"branch-options",P(R({...r,stat:i})))]),_:2},1032,["page","stat","depth","first-page-is-root","is-open","has-children","show-slugs","show-blueprint","editable","root","onEdit","onToggleOpen","onRemoved","onBranchClicked"])]),_:3},8,["modelValue","disable-drag","dir","node-key","each-droppable","root-droppable","max-level","stat-handler","onAfterDrop","onOpen:node","onClose:node"])],2))]),_:3},512),[[V,d.treeData.length]]),o(B,{open:d.discardingChanges,title:e.__("Discard Changes"),"body-text":e.__("Are you sure?"),"button-text":e.__("Discard Changes"),danger:!0,onConfirm:s.confirmDiscard,onCancel:a[1]||(a[1]=c=>d.discardingChanges=!1)},null,8,["open","title","body-text","button-text","onConfirm"])])}const oe=z(Z,[["render",ie]]);export{oe as default};
